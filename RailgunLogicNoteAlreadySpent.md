A transaction on my relay reverted with the message:


"Fail with error 'RailgunLogic: Note already spent'"

Upon further inspection, this looks like some time of transaction reordering attack. 

#### TX1

relay [0xD66C8b5d6eF988A99ba3fC94b26F765fc7182936](https://etherscan.io/address/0xd66c8b5d6ef988a99ba3fc94b26f765fc7182936) 's txid: 
[0x83972703c6f0ddd3453f5e7c30de485c4bc4d8814fc6c5894ba1285172ef97af](https://etherscan.io/tx/0x83972703c6f0ddd3453f5e7c30de485c4bc4d8814fc6c5894ba1285172ef97af) block # **21997654** : 


#### TX2
(my [relay](0x6F1674AD85f60D47959147Bf983ea9a43AdAa842), the target of this attack) **
**reverting** txid: [0x01de1df3c66b4582418b68748bd2de85c5fea132d28b3c3f9fe3b0ac1c7501e4](https://etherscan.io/tx/0x01de1df3c66b4582418b68748bd2de85c5fea132d28b3c3f9fe3b0ac1c7501e4) in block **21997655**

#### TX3


relay [0xD66C8b5d6eF988A99ba3fC94b26F765fc7182936](https://etherscan.io/address/0xd66c8b5d6ef988a99ba3fc94b26f765fc7182936) 's txid: 0xcaa4114f7c14ac343c5b5610607c502a9e2431d681a3bb7c9fda6edf3628ff1b in block **21997666**
[0xcaa4114f7c14ac343c5b5610607c502a9e2431d681a3bb7c9fda6edf3628ff1b](https://etherscan.io/tx/0xcaa4114f7c14ac343c5b5610607c502a9e2431d681a3bb7c9fda6edf3628ff1b)


#### Overview

![image](https://github.com/user-attachments/assets/076b4b0b-caf9-4d05-9486-dec65fdb73c2)


#### Analyis

<pre>
  
  
  JUMP
221,157

RailgunSmartWallet
.
verify
(_vk = null, _proof = {"a":{"x":"4224","y":"4288"},"b":{"x":["6825546094715185765981172177507287231605942939237136561640760583148801752983","14743496115785013626289762155220830377415000171907291271548099659475938879159"],"y":["9202207023456364277120877199544055292899848146120135621980396106604358701920","4352"]},"c":{"x":"4416","y":"3723285569402329004392548259648756665292186821606601497398613823116500277163"}}, _inputs = ["11760899481431823289328986727890880135150573710161656436072749175207323919653","3313902411608781359954679557316215517236864156368899588025944997521455123343","1711099485146509278689006563373132594498279087463014619891242003751977551789","14851897135718052847826757749278907976377253496523887485696601183249546830322","12149274168398395437491452789998518216531260233521006160322624899159433039825"])
=>
(true)
JUMP
6,400

RailgunSmartWallet
.
scalarMul
(p = {"x":"8026683210632629041252038608656817877487007634258568668589098718859135358452","y":"20271554317557705990763656896216337281894006867407980706726710299981708233981"}, s = 11760899481431823289328986727890880135150573710161656436072749175207323919653)
=>
({"x":"13144567205411303016844089005083690285938839620653739937846996161008886401194","y":"10730291543616677050976382097847174607788493482283854694637816683677015777761"})
S·CALL
6,000

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000007
)
.
0x11bef113
(0x11bef11358509d1aa6ea060366379433e3d9669573508401096ab3e815f915f42cd14b0b9637ff75c9a686938917a4e0227eedbf3bb7ed564c1eacb284878cfd1a006ee6f101d585a4bb6685eba2d8128bfd746821692baeaf7e2791efb26525)
JUMP
647

RailgunSmartWallet
.
add
(p1 = {"x":"0","y":"0"}, p2 = {"x":"13144567205411303016844089005083690285938839620653739937846996161008886401194","y":"10730291543616677050976382097847174607788493482283854694637816683677015777761"})
=>
({"x":"13144567205411303016844089005083690285938839620653739937846996161008886401194","y":"10730291543616677050976382097847174607788493482283854694637816683677015777761"})
S·CALL
150

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000006
)
.
0x00000000
(0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001d0f8fb743acf3141a1d417ac12cd8155b0247a441b35aa514a3a5a470dcc8aa17b92139ec2a677846496b18c3a27348e027477cabf5de9853a1dd0545f6a1e1)
JUMP
6,400

RailgunSmartWallet
.
scalarMul
(p = {"x":"6379845788709223537765948324591406778018439459784850431900825238723563444895","y":"2841206706611477111764792069369392710411349980332214091467285538050094600493"}, s = 3313902411608781359954679557316215517236864156368899588025944997521455123343)
=>
({"x":"17081359039696621881710856783256466928439938658574105975681091082173464065200","y":"17044892311006046294296812193994173749263643619545082255230940936066219549327"})
S·CALL
6,000

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000007
)
.
0x0e1add60
(0x0e1add60663054591761f647ad78ebf2a3d51f5b4baa8545c4d596c749d55a9f064810e5ea561c0e6e73d4d1e01e5a11e2d91159ad67c4a65b5b0318f20b112d07539a30144498d02356fc5ab4aab70bf91ae650af618874b16fd20cbf390b8f)
JUMP
647

RailgunSmartWallet
.
add
(p1 = {"x":"13144567205411303016844089005083690285938839620653739937846996161008886401194","y":"10730291543616677050976382097847174607788493482283854694637816683677015777761"}, p2 = {"x":"17081359039696621881710856783256466928439938658574105975681091082173464065200","y":"17044892311006046294296812193994173749263643619545082255230940936066219549327"})
=>
({"x":"19164018309716487024463168285264007770919526085735379172971691028476188570484","y":"21608439623488648653387437523403273390264155437667760237148648098009798435006"})
S·CALL
150

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000006
)
.
0x1d0f8fb7
(0x1d0f8fb743acf3141a1d417ac12cd8155b0247a441b35aa514a3a5a470dcc8aa17b92139ec2a677846496b18c3a27348e027477cabf5de9853a1dd0545f6a1e125c3b4e41f15f7cf555f27fc739c157585fea36508ac98eccbd27877f81634b025af1131fa5694e62f1e7231a8aede50127af6319e1f6057cd18851d4e96a28f)
JUMP
6,400

RailgunSmartWallet
.
scalarMul
(p = {"x":"18903572094910711022892650060064387233659153510979324729634548438732541285729","y":"13253964168646883941083552157248680501025676922062228626695682974632559920840"}, s = 1711099485146509278689006563373132594498279087463014619891242003751977551789)
=>
({"x":"1381800918083227962769822700980548633817144854696226642280882247722498510714","y":"13287047165791133898829636167044238876973967871738566780110640603682877488053"})
S·CALL
6,000

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000007
)
.
0x29cb0aea
(0x29cb0aead814424c93f380c0b4a5ec489c6b813ed228f7fee545c783197855611d4d7a5627426a7391ba3b14041e16ca6d4a7ae84f9d817a71faa0eb341246c803c872af58f182187aca59830047b605c22ecaaa70ff8778bcaadda262db07ad)
JUMP
648

RailgunSmartWallet
.
add
(p1 = {"x":"19164018309716487024463168285264007770919526085735379172971691028476188570484","y":"21608439623488648653387437523403273390264155437667760237148648098009798435006"}, p2 = {"x":"1381800918083227962769822700980548633817144854696226642280882247722498510714","y":"13287047165791133898829636167044238876973967871738566780110640603682877488053"})
=>
({"x":"20206002647231476186894192183799563367394512484743989171322905449734293081198","y":"11535577314350386939314126758626527215383404957265972306579274427493368144181"})
S·CALL
150

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000006
)
.
0x2a5e7331
(0x2a5e7331dce4e32c6a5695ea56fb12a2592e48804a78943b4c9fce8913b233742fc5f18394ff2fb81ed74778b38695570a9f1e33e2224ca0a4479554559c60be030e1254a4cff7f5069d05abd7ff61d0a58762dda73e702ff7dc8358dc0bcf7a1d6033c2b7e01cda2f2b5b3535653b62afa55e4d0151016bbf2aff4892303bb5)
JUMP
6,401

RailgunSmartWallet
.
scalarMul
(p = {"x":"2977930766637605233654544365914796966495714508098427114660475137907534249662","y":"8220788791820800152110807516457998889679808080417062929502977733489170970240"}, s = 14851897135718052847826757749278907976377253496523887485696601183249546830322)
=>
({"x":"10410120068896228346502191097590724261785566489169495033991932041708238545820","y":"7538336874697435420334172113635681465657450878284849346091667430194511148624"})
S·CALL
6,000

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000007
)
.
0x069572f7
(0x069572f728ca2ff7b3c243a4e51f0209d5a8039c9477015095b98608e1f6bebe122ccd338051379bd521bd23cd6f3cfde49b0feafc82707a78366e3ba1c1f68020d5e03a0d4445543c9e2b041fcd1f83e40aed515f813ad286814e5d9e2761f2)
JUMP
648

RailgunSmartWallet
.
add
(p1 = {"x":"20206002647231476186894192183799563367394512484743989171322905449734293081198","y":"11535577314350386939314126758626527215383404957265972306579274427493368144181"}, p2 = {"x":"10410120068896228346502191097590724261785566489169495033991932041708238545820","y":"7538336874697435420334172113635681465657450878284849346091667430194511148624"})
=>
({"x":"4796353662840831484087250007976978400732992516819079846099336661859439550243","y":"11437218002936860909044471709470541533684441899924203891512134419205598353053"})
S·CALL
150

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000006
)
.
0x2cac3134
(0x2cac3134ffc9cef7d21db1a8a05e7250a917a9a66655118d5daa10ae042acc6e1980e7c742dd2d997caaa5e1a70da6a0bd77b43dbebe3ca612020566513b21351703eb4de3b2a30272f78a146d34c0679fc3371f95a2598ec3a113c53d24239c10aa8c27040c772a76e0f9fa6377f675525d7865491dcd834c7f9eb4fe00f650)
JUMP
6,400

RailgunSmartWallet
.
scalarMul
(p = {"x":"4370657419078666235060440535484205217853448876684068042033967970916696415030","y":"11208503041500229026580571967993735685187236395624387281845754832671439726984"}, s = 12149274168398395437491452789998518216531260233521006160322624899159433039825)
=>
({"x":"3153200963116212159788893064632709212963551035228391260684075395862407401023","y":"12836896802610591768844289243711151995479819823393624338301290662602211911008"})
S·CALL
6,000

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000007
)
.
0x09a9b455
(0x09a9b455d05e80a9e6c0854a9d444e148cbbf37819cf6a577067e3c850bd5b3618c7c9b4371ec3f7aeb6ae9249564a5815bccf3c75873b1c1460c80a43ba29881adc3ed8b7d62536784e68ddd5cbe89b954389f7262ce50e81494c2f603a4fd1)
JUMP
649

RailgunSmartWallet
.
add
(p1 = {"x":"4796353662840831484087250007976978400732992516819079846099336661859439550243","y":"11437218002936860909044471709470541533684441899924203891512134419205598353053"}, p2 = {"x":"3153200963116212159788893064632709212963551035228391260684075395862407401023","y":"12836896802610591768844289243711151995479819823393624338301290662602211911008"})
=>
({"x":"10150658973826670214349796213271261818629205297985401596092368019207392746144","y":"9593119418978156374041002699624906558229196430294512732092490024032343338587"})
S·CALL
150

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000006
)
.
0x0a9aa3d5
(0x0a9aa3d51220d62c30735ba29643f717934a59d0a9af3b1080eed064c4bd1f2319493c69a1e91a2c8790e3ce7ad5bc093ff25674aeba8ce1ce6b1de7928e169d06f8a6041143d97738ad2f8284789c3b89e10344b14d5ceaa9d79f08cd03ce3f1c616d15c284275422cdebe561ad57d9d405c472540a87d701d710ceda28e560)
JUMP
648

RailgunSmartWallet
.
add
(p1 = {"x":"10150658973826670214349796213271261818629205297985401596092368019207392746144","y":"9593119418978156374041002699624906558229196430294512732092490024032343338587"}, p2 = {"x":"13269044056202146399820919099892397776003088154210227020920762890360179875004","y":"12875179799445375247728212743077945706810080164706598612393410486970765825967"})
=>
({"x":"12595198668568140578410771184820189976792527190113975085688968337857519054137","y":"12765280799169665872913541794098189328025364461979372782052998837127082769905"})
S·CALL
150

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000006
)
.
0x167111c2
(0x167111c2fe1366c4e5b0b79e4fcbb75e6e8a5ea370105258312e12677c9a5aa01535835f88122a9b9a67a301e9a4df1c936e78f818647a080553a53f84aaae5b1d56034645238d16f69ab8a8737032e2df8fd7cd9569a2cdb3b7f60b1ff75cbc1c7717f10878bc0f82c53bc9654c0d145ea3d94e588c61eec479106cb27057af)
JUMP
670

RailgunSmartWallet
.
negate
(p = {"x":"16933290474722063823141916295234668411104151675874224539246092056992057336596","y":"9202207023456364277120877199544055292899848146120135621980396106604358701920"})
=>
({"x":"16933290474722063823141916295234668411104151675874224539246092056992057336596","y":"12686035848382910945125528545713219795796463011177688040708641788040867506663"})

JUMP
182,001

RailgunSmartWallet
.
pairing
(_a1 = {"x":"16933290474722063823141916295234668411104151675874224539246092056992057336596","y":"12686035848382910945125528545713219795796463011177688040708641788040867506663"}, _a2 = {"x":["3723285569402329004392548259648756665292186821606601497398613823116500277163","19717361316217364954045759581070088489675337197896627938539417638033082248598"],"y":["3723285569402329004392548259648756665292186821606601497398613823116500277163","19717361316217364954045759581070088489675337197896627938539417638033082248598"]}, _b1 = {"x":"20491192805390485299153009773594534940189261866228447918068658471970481763042","y":"9383485363053290200918347156157836566562967994039712273449902621266178545958"}, _b2 = {"x":["4252822878758300859123897981450591353533073413197771768651442665752259397132","6375614351688725206403948262868962793625744043794305715222011528459656738731"],"y":["4252822878758300859123897981450591353533073413197771768651442665752259397132","6375614351688725206403948262868962793625744043794305715222011528459656738731"]}, _c1 = {"x":"12595198668568140578410771184820189976792527190113975085688968337857519054137","y":"12765280799169665872913541794098189328025364461979372782052998837127082769905"}, _c2 = {"x":["11559732032986387107991004021392285783925812861821192530917403151452391805634","10857046999023057135944570762232829481370756359578518086990519993285655852781"],"y":["11559732032986387107991004021392285783925812861821192530917403151452391805634","10857046999023057135944570762232829481370756359578518086990519993285655852781"]}, _d1 = {"x":"6825546094715185765981172177507287231605942939237136561640760583148801752983","y":"14743496115785013626289762155220830377415000171907291271548099659475938879159"}, _d2 = {"x":["7055862098856596640058882412211464890133949931482281741583495564333537133073","10065874739759802022941470945886473451585036482551002570165804295042848077915"],"y":["7055862098856596640058882412211464890133949931482281741583495564333537133073","10065874739759802022941470945886473451585036482551002570165804295042848077915"]})
=>
(true)
S·CALL
181,000

(
[Receiver]
PausableUpgradableProxy
 => 
0x0000000000000000000000000000000000000008
)
.
0x256fe71b
(0x256fe71bcd5a3ad1158aeb5c621f848b6a439a2c933c6184ebe34f00fba323141c0c0ab5f775128330ab7a6845cc1595bcad1da972504515325ab0bc369069e7083b4e115911d55d50c1bcee93fb43d148cbb21cd42a55f77ef165a2290417ab2b97a18ab1c3fd36ef995c7903d9c6e30be6e987e4cef0ca88999121c75b6d962888736e4fa6423130a17d7872a07400bc4dbe7699a42f6dd9dbb9801b08f60400d1ea197c7fdc52784c5521379bdfde8f7b6763253185d835efda0587813ee02d4d9aa7e302d9df41749d5507949d05dbea33fbb16c643b22f599a2be6df2e214bedd503c37ceb061d8ec60209fe345ce89830a19230301f076caff004d19260967032fcbf776d1afc985f88877f182d38480a653f2decaa9794cbc3bf3060c0e187847ad4c798374d0d6732bf501847dd68bc0e071241e0213bc7fc13db7ab304cfbd1e08a704a99f5e847d93f8c3caafddec46b7a0d379da69a4d112346a71739c1b1a457a8c7313123d24d2f9192f896b7c63eea05a9d57f06547ad0cec81bd8a13bb4b140f11b2309723eb474cc6ffd862fb1ee6a1f4fcfba8782dc6d391c38e4948e298f88bf5822767d0420d228d934a5e33104c7fc6687d5ad4d7df1198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa0f171f47902c9d3d7c5a756488b28ed8c705881b0c27163e7da4640c7d19ff97209885e8c0c876017f35fd823c8c3cba3f00fb919e15ef911bfd479da646a6b70f9979f6f46e8639c42baef43e074f616d970d820e139193fc7440cda2b182111641154cf7b8b32f871f013f28428443a30972fe749e09d92ba95ae83145385b20653ec9d3b096c6ac97a5ca8052bcd664b0eb64624183be4e94df320fa5a5cc19e46e912aeae191d4f930359d9b6ef716144da5a79b74485204e24950bf6351)
JUMP
3,166

RailgunSmartWallet
.
accumulateAndNullifyTransaction
(_transaction = null, _commitments = ["0x0000000000000000000000000000000000000000000000000000000000000000","0x0000000000000000000000000000000000000000000000000000000000000000","0x0000000000000000000000000000000000000000000000000000000000000000"], _commitmentsStartOffset = 0, _ciphertext = null)
SLOAD
2,100

RailgunSmartWallet
[
0x7f54f68969af0ff9c936ebad45c10ac74ccfde94cb9b8ff2ce8dddc2a6627e9d = 0x0000000000000000000000000000000000000000000000000000000000000001
]
REVERT
0

RailgunSmartWallet
.
accumulateAndNullifyTransaction
(0x)
  
  
</pre>


![image](https://github.com/user-attachments/assets/6923bc92-ec9b-4d95-9bde-3697f83c80d9)


#### TDLR

<pre>
  {
  "[OPCODE]": "SLOAD",
  "storage": [
    {
      "varName": "0x7f54f68969af0ff9c936ebad45c10ac74ccfde94cb9b8ff2ce8dddc2a6627e9d",
      "value": "0x0000000000000000000000000000000000000000000000000000000000000001"
    }
  ],
  "gas": {
    "gas_left": 1404170,
    "gas_used": 2100,
    "total_gas_used": 392825
  }
}
</pre>

#### Reverting Functions Source

**The Issue** seems to be that the contract thinks this utxo is already spent? Or the log for this message call already 'nullified'? 


<pre>
  /**
   * @notice Accumulates transaction fields and nullifies nullifiers
   * @param _transaction - transaction to process
   * @param _commitments - commitments accumulator
   * @param _commitmentsStartOffset - number of commitments already in the accumulator
   * @param _ciphertext - commitment ciphertext accumulator, count will be identical to commitments accumulator
   * @return New nullifier start offset, new commitments start offset
   */
  function accumulateAndNullifyTransaction(
    Transaction calldata _transaction,
    bytes32[] memory _commitments,
    uint256 _commitmentsStartOffset,
    CommitmentCiphertext[] memory _ciphertext
  ) internal returns (uint256) {
    // Loop through each nullifier
    for (
      uint256 nullifierIter = 0;
      nullifierIter < _transaction.nullifiers.length;
      nullifierIter += 1
    ) {
      // If nullifier has been seen before revert
      require(
        !Commitments.nullifiers[_transaction.boundParams.treeNumber][
          _transaction.nullifiers[nullifierIter]
        ],
        "RailgunLogic: Note already spent"
      );

      // Set nullifier to seen
      Commitments.nullifiers[_transaction.boundParams.treeNumber][
        _transaction.nullifiers[nullifierIter]
      ] = true;
    }

    // Emit nullifier event
    emit Nullified(_transaction.boundParams.treeNumber, _transaction.nullifiers);

    // Loop through each commitment
    for (
      uint256 commitmentsIter = 0;
      // The last commitment should NOT be accumulated if transaction includes unshield
      // The ciphertext length is validated in the transaction validity function to reflect this
      commitmentsIter < _transaction.boundParams.commitmentCiphertext.length;
      commitmentsIter += 1
    ) {
      // Push commitment to commitments accumulator
      _commitments[_commitmentsStartOffset + commitmentsIter] = _transaction.commitments[
        commitmentsIter
      ];

      // Push ciphertext to ciphertext accumulator
      _ciphertext[_commitmentsStartOffset + commitmentsIter] = _transaction
        .boundParams
        .commitmentCiphertext[commitmentsIter];
    }

    // Return new starting offset
    return _commitmentsStartOffset + _transaction.boundParams.commitmentCiphertext.length;
  }
</pre>

#### Proprosed Solution

**THIS IS A VULNERABILITY. NO NODE IS SAFE TILL IT"S PATCHED!**

Instead of reverting on already nullified logs, emit an event so that someone can analyse the issue further (for the time being), but DO NOT revert. 
This will allow the tx to mine and the relay operator to get paid rather than loosing the gas in the  failed tx! 

*Thought tx's wont revert with railgun*? 

##### Potential solution for now
<pre>
function accumulateAndNullifyTransaction(
    //@dev log duplicate but do not revert entire transaction
    event DuplicateNullified(uint16 treeNumber, bytes32[] nullifier);

    Transaction calldata _transaction,
    bytes32[] memory _commitments,
    uint256 _commitmentsStartOffset,
    CommitmentCiphertext[] memory _ciphertext
  ) internal returns (uint256) {
    // Loop through each nullifier
    
    for (
      uint256 nullifierIter = 0;
      nullifierIter < _transaction.nullifiers.length;
      nullifierIter += 1
    ) {
      // If nullifier has been seen before <s>revert</s> log it
        if (Commitments.nullifiers[_transaction.boundParams.treeNumber] {
        emit DuplicateNullified((_transaction.boundParams.treeNumber, _transaction.nullifiers);
        } else {
        

      // Set nullifier to seen
      Commitments.nullifiers[_transaction.boundParams.treeNumber][
        _transaction.nullifiers[nullifierIter]
      ] = true;
       // Emit nullifier event
   
        emit Nullified(_transaction.boundParams.treeNumber, _transaction.nullifiers);
    
    }

   
    
    // ... EOF ... 
  
</pre>


